# gradle-conventions

Shared Gradle conventions for `leanish`, JDK-based projects.

## What it provides
- Applies common plugins: `java`, `checkstyle`, `jacoco` (coverage), `spotless` (static analysis).
- Configures Java toolchain, runtime launcher, and bytecode level (defaults to Eclipse Adoptium JDK 25).
- The plugin itself uses Kotlin/JVM 21 (Kotlin does not yet support targeting 25); Java toolchain defaults remain 25.
- Sets Checkstyle tool version and uses the bundled Checkstyle config (project suppressions are optional).
- Sets JaCoCo tool version and enforces instruction coverage.
- Configures Spotless for basic Java formatting (unused imports, trailing whitespace, newline at EOF).
- Adds common compile/test dependencies (Lombok, JSpecify, JetBrains annotations, Error Prone/NullAway).
- Adds root-only helper tasks (`installGitHooks`, `setupProject`) and makes `build` depend on `installGitHooks`.
  The `installGitHooks` task installs the bundled `pre-commit` hook unless the project provides
  `scripts/git-hooks/pre-commit`.
- Makes `check` depend on `jacocoTestCoverageVerification`.

## JDK configuration
The plugin exposes JDK knobs so you can control compiler, bytecode, and runtime independently:
1. `compilerJdkVersion` picks the JDK used by `javac` and annotation processors.
2. `bytecodeJdkVersion` sets the `--release` level for generated bytecode.
3. `runtimeJdkVersion` selects the JDK used by `Test` and `JavaExec`.
4. `compilerJdkVendor` defines the vendor used for compiler resolution.
5. `runtimeJdkVendor` defines the vendor used for runtime resolution.
6. `jdkVendor` is a convenience setter that keeps compiler/runtime vendors aligned.
7. `jdkVersion` is a convenience setter that keeps compiler/bytecode/runtime aligned.

## Configuration reference
Extension type: `io.github.leanish.gradleconventions.GradleConventionsExtension` (configured via `gradleConventions { ... }`).
- `errorproneArgs`: Error Prone + NullAway arguments appended to the defaults.
- `testJvmArgs`: JVM args applied to all `Test` tasks.
- `javaExecJvmArgs`: JVM args applied to all `JavaExec` tasks (bootRun, etc.).
- `spotlessConfig`: Spotless root hook (defaults to basic Java hygiene steps; override to replace).
- `minimumCoverage`: JaCoCo instruction coverage ratio enforced by `jacocoTestCoverageVerification`.
- `jdkVersion`: Convenience setter that updates compiler/bytecode/runtime together.
- `bytecodeJdkVersion`: Bytecode level used for `javac --release`.
- `compilerJdkVersion`: JDK used by `javac` and annotation processors (JavaCompile tasks).
- `runtimeJdkVersion`: JDK used to run tests and `JavaExec` tasks.
- `compilerJdkVendor`: Vendor used by `javac` and annotation processors.
- `runtimeJdkVendor`: Vendor used to run tests and `JavaExec` tasks.
- `jdkVendor`: Convenience setter that updates compiler/runtime vendors together.

## How to use
1) Publish the plugin (to `mavenLocal`).
2) Add it to `settings.gradle.kts`:

```kotlin
pluginManagement {
    repositories {
        mavenLocal()
        gradlePluginPortal()
        mavenCentral()
    }
    plugins {
        id("io.github.leanish.gradle-conventions") version "0.1.0"
    }
}
```

3) Apply and configure in `build.gradle.kts`:

```kotlin
plugins {
    id("io.github.leanish.gradle-conventions")
}

gradleConventions {
    // Mutate ErrorProne / NullAway settings (defaults are pre-populated).
    errorproneArgs.add("-XepOpt:NullAway:ExcludedPackages=io.github.leanish.example")
    // errorproneArgs.remove("-Xep:FutureReturnValueIgnored:OFF")

    // Custom JVM args for app run tasks or tests.
    javaExecJvmArgs.add("--enable-native-access=ALL-UNNAMED")
    testJvmArgs.add("--enable-native-access=ALL-UNNAMED")
    testJvmArgs.add("-Duser.timezone=UTC")

    // Optional: replace defaults entirely with custom Spotless steps.
    // spotlessConfig = org.gradle.api.Action {
    //     java {
    //         importOrder("java", "javax", "org", "com", "")
    //         googleJavaFormat("1.23.0")
    //     }
    //     // Non-Java formatters work here too.
    //     kotlin {
    //         ktlint("1.2.1")
    //     }
    //     format("markdown") {
    //         target("**/*.md")
    //         trimTrailingWhitespace()
    //         endWithNewline()
    //     }
    // }

    // compiler/bytecode/runtime tuning (defaults shown below).
    bytecodeJdkVersion = 25
    compilerJdkVersion = 25
    runtimeJdkVersion = 25
    compilerJdkVendor = org.gradle.jvm.toolchain.JvmVendorSpec.ADOPTIUM
    runtimeJdkVendor = org.gradle.jvm.toolchain.JvmVendorSpec.ADOPTIUM
    // or: jdkVendor = org.gradle.jvm.toolchain.JvmVendorSpec.ADOPTIUM

    // Instruction coverage minimum. Default is 0.85.
    minimumCoverage = "0.88".toBigDecimal()
}
```

Note: mutations to `gradleConventions` must happen during Gradle configuration
(i.e., inside the build scriptâ€™s configuration phase). Changes made later (for example,
inside `doFirst`/`doLast` task actions) will not be picked up.

## Coverage behavior
- Enforces instruction coverage via `jacocoTestCoverageVerification`.
- Default minimum is `0.85` unless overridden in `gradleConventions`.
- Set `-DexcludeTags=integration` (or any tags) to skip those tests and disable coverage verification.

## ErrorProne
The conventions plugin applies `net.ltgt.errorprone` and adds Error Prone + NullAway dependencies automatically.
It:
- Adds `-XDaddTypeAnnotationsToSymbol=true`.
- Configures ErrorProne with the args from `gradleConventions.errorproneArgs` (defaults included).
- Disables ErrorProne for `compileTestJava`.

## Notes
- Checkstyle uses the configuration bundled in this plugin. If `config/checkstyle/suppressions.xml` exists, it is applied; otherwise no suppressions are used.
- The plugin does not add a toolchain resolver; ensure the configured JDK is available locally or add a resolver in the consuming project.
